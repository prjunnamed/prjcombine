<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Digilent Adept - Project Combine</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom-5e178fcf.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-89d00db4.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">Project Combine</h1>

                    <div class="right-buttons">

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="digilent-adept"><a class="header" href="#digilent-adept">Digilent Adept</a></h1>
<p>Digilent made a family of devboards using a common custom USB protocol.
For lack of a better name, we call it the Digilent Adept protocol.</p>
<p>The protocol is designed to be extensible: there is a set of control requests
that can be used to query information about the board and the capabilities,
and then there is a common multiplexing and framing protocol used to
communicate with one of the device’s “subsystems”, such as JTAG, SPI, GPIO,
or board management.</p>
<p>There ar two kinds of devices implementing this protocol:</p>
<ul>
<li>AT90USB162-based, which have pre-flashed firmware and can be used immediately</li>
<li>FX2-based, which may require firmware upload first</li>
</ul>
<p>TODO: there are also FX3-based devices, but it is unclear whether they reuse
the protocol or not</p>
<p>Note that Digilent has phased out this protocol — newer boards are FTDI based instead.
On FTDI-based boards, the Adept runtime libraries will emulate this protocol in software, even
assembling command structures in one part of the stack, then destructuring them in the FTDI-specific
code.  The code doing this (a normal host <code>.so</code> or <code>.dll</code>) is, hilariously, called “firmware”.</p>
<p>The protocol is implemented on devices with USB ID of <code>0x1443:0x0007</code>.</p>
<p>TODO: <code>0x1443:0x0003</code> and <code>0x1443:0x0005</code> allegedly also exist, on
the oldest FX2-based devices</p>
<p>The device exposes a single configuration and single interface.  The class,
subclass, and protocol are all-0, as would be expected.  The device has
the following endpoints:</p>
<ul>
<li>control endpoint 0: in addition to the usual core USB stuff, used to send
various custom control requests</li>
<li>command endpoint (bulk OUT): used to send subsystem commands</li>
<li>response endpoint (bulk IN): used to receive subsystem command responses</li>
<li>data out endpoint (bulk OUT): used to send large data payloads for subsystem commands</li>
<li>data in endpoint (bulk IN): used to receive large data payloads for subsystem commands</li>
</ul>
<p>The actual endpoint numbers (and their max packet size) involved depend on the device kind:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Endpoint</th><th>FX2</th><th>AT90USB</th></tr>
</thead>
<tbody>
<tr><td>command</td><td>EP1 OUT (64 bytes)</td><td>EP1 OUT (16 bytes)</td></tr>
<tr><td>response</td><td>EP1 OUT (64 bytes)</td><td>EP2 IN (16 bytes)</td></tr>
<tr><td>data out</td><td>EP2 OUT (64/512 bytes)</td><td>EP3 OUT (64 bytes)</td></tr>
<tr><td>data in</td><td>EP6 IN (64/512 bytes)</td><td>EP4 IN (64 bytes)</td></tr>
</tbody>
</table>
</div>
<p>All numbers in the protocol are encoded as little-endian unless stated otherwise.</p>
<h2 id="identification"><a class="header" href="#identification">Identification</a></h2>
<p>All Adept devices will present useless data (something akin to <code>"Digilent Adept USB"</code>) in their
USB identifier strings.  To identify the actual devboard, the “product id” should be obtained
instead (via <code>GET_PRODUCT_ID</code> control request, or by reading from user EEPROM area on FTDI
devices).  The product id is a 32-bit word with the following structure:</p>
<ul>
<li>bits 0-7: firmware id</li>
<li>bits 8-19: variant id</li>
<li>bits 20-31: board id</li>
</ul>
<p>The “board id” identifies a particular devboard model.  The “variant id” identifies a variant of
that devboard (eg. what FPGA size is fitted).  The “firmware id” identifies which firmware should
be loaded for this board.</p>
<p>The “firmware id” can be thought of as identifying an “equivalence class” of the board from
the firmware’s port of view:</p>
<ul>
<li>two completely different boards that both use the same set of subsystems (eg. both use DJTG+DEPP)
and have the exact same control connections to the FX2/AT90USB are equivalent, and will have
the same firmware id</li>
<li>two minor revisions of the same board will get distinct firmware id if the connections to
the AT90USB/FX2 were changed (eg. hooked up a “link activity” LED on the newer revision)</li>
</ul>
<p>The known firmware ids are:</p>
<ul>
<li><code>0x00-0x1f</code>: FX2-based; <code>0x01</code> and <code>0x02</code> are based on the original FX2, all others are
based on FX2LP
<ul>
<li><code>0x01</code>: DJTG or DSPI; old JTAG-USB cable based on the original FX2, requires firmware swapping
to switch between DJTG and DSPI</li>
<li><code>0x02</code>: DJTG or DEPP: old USB2 module based on the original FX2, requires firmware swapping
to switch between DJTG and DEPP</li>
<li><code>0x03</code>: DJTG + DSPI; new FX2LP-based JTAG-USB cable</li>
<li><code>0x04</code>: DJTG + DEPP; new FX2LP-based USB2 module</li>
<li><code>0x05</code>: DJTG+DEPP+DSTM (used on Nexys 2)</li>
<li><code>0x06</code>: DJTG+DEPP+DSTM+DSPI (X-board?)</li>
<li><code>0x08</code>: DJTG+DEPP+DSTM</li>
<li><code>0x09</code>: DJTG+DEPP+DSTM</li>
<li><code>0x0a</code>: DJTG+DEPP+DSTM+DSPI (X-board?)</li>
<li><code>0x0b</code>: ~DJTG+DEPP+DSTM</li>
<li><code>0x0c</code>: DJTG+DEPP+DSTM (used on Atlys)</li>
<li><code>0x0d</code>: DJTG+DEPP+DSTM (used on Nexys 3, FMC Carrier S6)</li>
<li><code>0x0e</code>: DJTG+DEPP+DSTM</li>
<li><code>0x0f</code>: ~DJTG+DEPP+DSTM</li>
</ul>
</li>
<li><code>0x20-0x3f</code>: AT90USB-based
<ul>
<li><code>0x21</code>: DJTG? (JTAG-USB-FS cable)</li>
<li><code>0x22</code>: DJTG+DEPP + prog + done (used on Basys 2)</li>
<li><code>0x23</code>: DJTG+DEPP + ??? (used on other Basys 2 revisions?)</li>
<li><code>0x26</code>: DJTG+DEPP+DSPI (used on Coolrunner 2 starter board)</li>
<li><code>0x29</code>: DPIO+DSPI+DTWI+DACI+DAIO+DEMC+DGIO (IO explorer)</li>
<li><code>0x2d</code>: DJTG+???</li>
<li><code>0x2e</code>: DPIO+DEPP+DSPI; power control shared with DPIO (used on iCE40blink)</li>
</ul>
</li>
<li><code>0x50-0x6f</code>: FTDI-based
<ul>
<li><code>0x50</code>: FT2232H DJTG+DSPI (JTAG-HS1)</li>
<li><code>0x51</code>: FT2232H DJTG (used on JTAG-SMT1; Basys 3, Arty, USB104-A7, USRP onboard)</li>
<li><code>0x52</code>: FT232H DJTG+DSPI (JTAG-HS2)</li>
<li><code>0x53</code>: DJTG+SRST (JTAG-HS3; ZEDBOARD)</li>
<li><code>0x54</code>: FT232H DJTG+DSPI+DPIO (JTAG-SMT2)</li>
<li><code>0x55</code>: DJTG+DSPI+DPTI</li>
<li><code>0x56</code>: DJTG+DSPI+DPTI</li>
<li><code>0x57</code>: DJTG (ZYBO-Z7; TE07* onboard)</li>
<li><code>0x58</code>: DJTG+DSPI</li>
<li><code>0x59</code>: DPTI</li>
<li><code>0x60</code>: ~DJTG+DPTI (analog discovery)</li>
<li><code>0x61</code>: DJTG</li>
<li><code>0x62</code>: DSPI+DPTI</li>
</ul>
</li>
<li><code>0x80-0x8f</code>: FX3-based
<ul>
<li><code>0x80</code>: ???</li>
<li><code>0x81</code>: ???</li>
</ul>
</li>
</ul>
<p>In addition to the binary product id, the boards also have a product name, which is hopefully in
some correspondence with the product id.  However, it is probably more reliable to recognize
the board by the binary id.</p>
<h2 id="control-requests"><a class="header" href="#control-requests">Control requests</a></h2>
<p>These control requests can be sent at any time, without any particular
preparation.</p>
<p>A few of the requests here deal with strings.  The strings are stored
on the board in fixed-length storage (different for every string),
and are NUL-terminated, except for the (legal) case of a string that takes
up the entire length of the storage.  The requests will return the entire
contents of the string storage, possibly including garbage beyond the NUL
terminator (which is usually either all-NUL or all-<code>0xff</code>).  This garbage
should be trimmed off.</p>
<h3 id="get_product_name"><a class="header" href="#get_product_name"><code>GET_PRODUCT_NAME</code></a></h3>
<p>Returns a product name describing the board.  The storage for that string
is 28 bytes long.</p>
<ul>
<li><code>bmRequestType</code>: <code>0xc0</code></li>
<li><code>bRequest</code>: <code>0xe1</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 28</li>
</ul>
<h3 id="get_user_name"><a class="header" href="#get_user_name"><code>GET_USER_NAME</code></a></h3>
<p>Returns a “user name” describing the board.  It is a 16-byte string field.
Allegedly it can be set by the user.</p>
<ul>
<li><code>bmRequestType</code>: <code>0xc0</code></li>
<li><code>bRequest</code>: <code>0xe2</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 16</li>
</ul>
<h3 id="set_user_name"><a class="header" href="#set_user_name"><code>SET_USER_NAME</code></a></h3>
<p>Sets the user name of this board.  It can be up to 16 bytes long.
Doesn’t seem to be actually supported on all boards?</p>
<ul>
<li><code>bmRequestType</code>: <code>0x40</code></li>
<li><code>bRequest</code>: <code>0xe3</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 16</li>
</ul>
<h3 id="get_serial_number"><a class="header" href="#get_serial_number"><code>GET_SERIAL_NUMBER</code></a></h3>
<p>Returns the serial number of this board.  It is 12 bytes long.  It can be
reprogrammed by the user.</p>
<ul>
<li><code>bmRequestType</code>: <code>0xc0</code></li>
<li><code>bRequest</code>: <code>0xe4</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 12</li>
</ul>
<h3 id="set_serial_number"><a class="header" href="#set_serial_number"><code>SET_SERIAL_NUMBER</code></a></h3>
<p>Sets the serial number of this board.  It can be up to 12 bytes long.</p>
<ul>
<li><code>bmRequestType</code>: <code>0x40</code></li>
<li><code>bRequest</code>: <code>0xe5</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 12</li>
</ul>
<h3 id="get_firmware_version"><a class="header" href="#get_firmware_version"><code>GET_FIRMWARE_VERSION</code></a></h3>
<p>Returns the firmware version of this board.  It is a 16-bit word.</p>
<ul>
<li><code>bmRequestType</code>: <code>0xc0</code></li>
<li><code>bRequest</code>: <code>0xe6</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 2</li>
</ul>
<h3 id="get_caps"><a class="header" href="#get_caps"><code>GET_CAPS</code></a></h3>
<p>Returns the capabilities of this board.  It is a 32-bit word.</p>
<ul>
<li><code>bmRequestType</code>: <code>0xc0</code></li>
<li><code>bRequest</code>: <code>0xe7</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 4</li>
</ul>
<p>The capabilities are a bitfield describing the available subsystems:</p>
<ul>
<li>bit 0: DJTG</li>
<li>bit 1: DPIO</li>
<li>bit 2: DEPP</li>
<li>bit 3: DSTM</li>
<li>bit 4: DSPI</li>
<li>bit 5: DTWI</li>
<li>bit 6: DACI</li>
<li>bit 7: DAIO</li>
<li>bit 8: DEMC</li>
<li>bit 9: DDCI</li>
<li>bit 10: DGIO</li>
</ul>
<h3 id="set_secret_handshake"><a class="header" href="#set_secret_handshake"><code>SET_SECRET_HANDSHAKE</code></a></h3>
<p>Sets a 16-bit number used in the secret handshake.</p>
<ul>
<li><code>bmRequestType</code>: <code>0x40</code></li>
<li><code>bRequest</code>: <code>0xe8</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 2</li>
</ul>
<h3 id="get_product_id"><a class="header" href="#get_product_id"><code>GET_PRODUCT_ID</code></a></h3>
<p>Returns the binary product ID of this board.  It is a little-endian 32-bit word, explained above.</p>
<ul>
<li><code>bmRequestType</code>: <code>0xc0</code></li>
<li><code>bRequest</code>: <code>0xe9</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 4</li>
</ul>
<h3 id="get_secret_handshake"><a class="header" href="#get_secret_handshake"><code>GET_SECRET_HANDSHAKE</code></a></h3>
<p>Gets a secret 32-bit handshake number from the board.  This is a strong
cryptographic protocol used to verify the board as a genuine Digilent product.
A secret 16-bit nonce must first be set via the <code>SET_SECRET_HANDSHAKE</code>
request, then this request must be used to get a 32-bit MAC from the device.</p>
<ul>
<li><code>bmRequestType</code>: <code>0xc0</code></li>
<li><code>bRequest</code>: <code>0xec</code></li>
<li><code>wValue</code>: 0</li>
<li><code>wIndex</code>: 0</li>
<li><code>wLength</code>: 4</li>
</ul>
<p>To verify the device as a genuine Digilent board, check the MAC is correct
as follows:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn correct_mac(nonce: u16, mac: u32) -&gt; bool {
    let byte_nonce = (((nonce &gt;&gt; 8) ^ nonce) &amp; 0xff) as u32;
    const DIGILENT_PUBLIC_KEY: u32 = 0x69676944;
    mac == (DIGILENT_PUBLIC_KEY ^ (byte_nonce | byte_nonce &lt;&lt; 8 | byte_nonce &lt;&lt; 16 | byte_nonce &lt;&lt; 24))
}
<span class="boring">}</span></code></pre>
<h2 id="subsystem-commands"><a class="header" href="#subsystem-commands">Subsystem commands</a></h2>
<p>All commands other than the above control requests are handled via a uniform
protocol over endpoints 1-4.  Commands are targetted to particular “subsystem”
and a particular “port” (or, in other words, instance) of that subsystem.
The following subsystems can exist:</p>
<ul>
<li><code>0x00</code>: SYS (manages other subsystems, always present, always 1 “port”)</li>
<li><code>0x01</code>: DMGT (general board management, always present, always 1 “port”)</li>
<li><code>0x02</code>: DJTG (JTAG, bit 0 in <code>GET_CAPS</code>)</li>
<li><code>0x03</code>: DPIO (simple GPIO, bit 1 in <code>GET_CAPS</code>)</li>
<li><code>0x04</code>: DEPP (EPP-like parallel port, bit 2 in <code>GET_CAPS</code>)</li>
<li><code>0x05</code>: DSTM (FX2 FIFO interface, bit 3 in <code>GET_CAPS</code>)</li>
<li><code>0x06</code>: DSPI (SPI, bit 4 in <code>GET_CAPS</code>)</li>
<li><code>0x07</code>: DTWI (I²C / SMBus, bit 5 in <code>GET_CAPS</code>)</li>
<li><code>0x08</code>: DACI (UART, bit 6 in <code>GET_CAPS</code>)</li>
<li><code>0x09</code>: DAIO (analog I/O, bit 7 in <code>GET_CAPS</code>)</li>
<li><code>0x0a</code>: DEMC (electro-mechanical control, bit 8 in <code>GET_CAPS</code>)</li>
<li><code>0x0c</code>: DGIO (general sensor and user I/O, bit 10 in <code>GET_CAPS</code>)</li>
</ul>
<p>TODO: list incomplete</p>
<p>Commands are sent on endpoint 1, and have the following general format:</p>
<ul>
<li>byte 0: command length in bytes, minus one</li>
<li>byte 1: target subsystem</li>
<li>byte 2:
<ul>
<li>bits 0-6: command type</li>
<li>bit 7:
<ul>
<li><code>0</code>: this is a short command, or the start of a long command</li>
<li><code>1</code>: this is the end of a long command</li>
</ul>
</li>
</ul>
</li>
<li>byte 3: target port (if not applicable, set to 0)</li>
<li>bytes 4 and up (if any): short payload, determined by subsystem and command type</li>
</ul>
<p>Responses to commands are received on endpoint 2, and have the following general format:</p>
<ul>
<li>byte 0: response length in bytes, minus one</li>
<li>byte 1:
<ul>
<li>bits 0-5: status code
<ul>
<li><code>0x00</code>: success, payload determined by command type</li>
<li><code>0x01</code>: command not supported (no payload)</li>
<li><code>0x03</code>: resource in use (attempt to enable a port that is already enabled, or that uses resources shared with another enabled port), no payload</li>
<li><code>0x04</code>: port disabled error (attempt to send a non-enable command to disabled port), no payload</li>
<li><code>0x05</code>: DEPP address timeout (no payload)</li>
<li><code>0x06</code>: DEPP data timeout
<ul>
<li>payload: 32-bit number (unknown semantics)</li>
</ul>
</li>
<li><code>0x0d</code>: command parameter out of range (no payload)</li>
<li><code>0x31</code>: unknown subsystem (no payload)</li>
<li><code>0x32</code>: unknown command (no payload)</li>
</ul>
</li>
<li>bit 6: if set, a “received byte count” field is present in the reply</li>
<li>bit 7: if set, a “transmitted byte count” field is present in the reply</li>
</ul>
</li>
<li>bytes 2 and up (if any): several packed fields, in order:
<ul>
<li>if status code is non-0: error payload specific to status code</li>
<li>if bit 7 of byte 1 set: a 32-bit word containing “transmitted byte count” (the number of bytes sent over data out endpoint for a long command)</li>
<li>if bit 6 of byte 1 set: a 32-bit word containing “received byte count” (the number of bytes sent over data in endpoint for a long command)</li>
<li>if status code is 0: short response payload, determined by subsystem and command type</li>
</ul>
</li>
</ul>
<p>Commands and responses are short and fit in one USB packet, which can be at most 16 bytes for the relevant endpoints.</p>
<p>Commands come in two kinds: short and long.  Whether a command is short
or long depends only on its subsystem and command type.  A short command
simply consists of two USB transfers:</p>
<ul>
<li>command endpoint: command to device</li>
<li>response endpoint: response from device</li>
</ul>
<p>A long command is one that possibly takes a long time and can be aborted (via the <code>SYS_ABORT</code> command).
Long commands can also involve large data transfers over endpoints 3 and 4.  A long consists of the following transfers:</p>
<ul>
<li>command endpoint: start command to device (bit 7 of byte 2 set to 0; short payload contains command arguments, if any)</li>
<li>response endpoint: response from device (if not successful, the command is aborted now)</li>
<li>data out endpoint and/or data in endpoint (if needed): large payload to/from device (if both are needed, the two transfers may have to be overlapped)</li>
<li>command endpoint: end command to device (bit 7 of byte 2 set to 1; no short payload present)</li>
<li>response endpoint: response from device (contains actual transmitted and received byte counts, as appropriate)</li>
</ul>
<h2 id="system-management-commands"><a class="header" href="#system-management-commands">System management commands</a></h2>
<p>The “subsystem” 0 (“SYS”) is special, always present, and always enabled.</p>
<h3 id="sys_abort-command"><a class="header" href="#sys_abort-command"><code>SYS_ABORT</code> command</a></h3>
<p>This command can be sent in the middle of a long command to abort the transfer.</p>
<ul>
<li>subsystem: <code>0x00</code> (SYS)</li>
<li>command type: <code>0x02</code> (short)</li>
<li>port: N/A, always 0</li>
<li>command payload: none</li>
<li>response payload: none</li>
</ul>
<h3 id="sys_reset-command"><a class="header" href="#sys_reset-command"><code>SYS_RESET</code> command</a></h3>
<p>This command can be sent at any time to reset the current state of the device.
This involves disabling all ports.</p>
<ul>
<li>subsystem: <code>0x00</code> (SYS)</li>
<li>command type: <code>0x03</code> (short)</li>
<li>port: N/A, always 0</li>
<li>command payload: 32-bit word</li>
<li>response payload: 32-bit word</li>
</ul>
<p>For unknown reasons, this command takes a 32-bit word payload, and returns as the response payload another 32-bit word, which is equal to <code>0x7a - command_payload</code>.</p>
<h2 id="general-subsystem-commands"><a class="header" href="#general-subsystem-commands">General subsystem commands</a></h2>
<p>These commands apply to all supported subsystems except <code>SYS</code> and <code>DMGT</code>.</p>
<h3 id="enable-command"><a class="header" href="#enable-command"><code>ENABLE</code> command</a></h3>
<p>This command enables a subsystem port, making it ready for use.  The only
commands that can be sent to a disabled port are <code>ENABLE</code> and
<code>GET_CAPABILITIES</code>.  All ports start out as disabled.  A port will fail
to enable if it is already enabled, or if another port using the same hardware
resources is currently enabled.</p>
<ul>
<li>subsystem: any except SYS and DMGT</li>
<li>command type: <code>0x00</code> (short)</li>
<li>port: port index</li>
<li>command payload: none</li>
<li>response payload: none</li>
</ul>
<h3 id="disable-command"><a class="header" href="#disable-command"><code>DISABLE</code> command</a></h3>
<p>Disables a subsystem port, undoing the <code>ENABLE</code> command.</p>
<ul>
<li>subsystem: any except SYS and DMGT</li>
<li>command type: <code>0x01</code> (short)</li>
<li>port: port index</li>
<li>command payload: none</li>
<li>response payload: none</li>
</ul>
<h3 id="get_port_properties-command"><a class="header" href="#get_port_properties-command"><code>GET_PORT_PROPERTIES</code> command</a></h3>
<p>Returns the properties of a given port of a subsystem, and also the available port count.</p>
<ul>
<li>subsystem: any except SYS and DMGT</li>
<li>command type: <code>0x02</code> (short)</li>
<li>port: port index; call with port 0 to obtain number of available ports</li>
<li>command payload: 1 byte: requested data byte count (can be 1 or 5)</li>
<li>response payload:
<ul>
<li>byte 0: port count</li>
<li>bytes 1-4 (if requested): 32-bit word, port properties; exact meaning depends on subsystem</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../coolrunner2/devices/xc2c512.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../digilent/dmgt.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../coolrunner2/devices/xc2c512.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../digilent/dmgt.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>



        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
