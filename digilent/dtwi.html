<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>DTWI (I2C controller) - Project Combine</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                    </div>

                    <h1 class="menu-title">Project Combine</h1>

                    <div class="right-buttons">

                    </div>
                </div>


                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dtwi-i2c-controller"><a class="header" href="#dtwi-i2c-controller">DTWI (I2C controller)</a></h1>
<p>This subsystem implements an I²C / SMBus controller and/or peripherial.  The name stands
for "two-wire interface", lest Phillips lawyers get unhappy.</p>
<p>The port properties on DTWI are as follows:</p>
<ul>
<li>bit 0: supports operating as a controller</li>
<li>bit 1: supports operating as a peripherial</li>
<li>bit 2: supports operating as a controller in multi-controller environment</li>
<li>bit 3: supports the <code>CONTROLLER_BATCH</code> command</li>
<li>bit 4: supports the <code>SET_SPEED</code> command</li>
<li>bit 5: supports SMB alert pin</li>
<li>bit 6: supports SMB suspend pin</li>
<li>bit 7: supports SMB packet error checking</li>
</ul>
<p>The subsystem supports only 7-bit addresses.  The addresses used in the protocol are specified
as numbers in the range of 0-127.</p>
<p>When operating in peripherial mode, the device functions as a simple bidirectional FIFO with
a predetermined buffer size in each direction.  The buffer in the USB host → device direction
is called the Tx buffer, while the buffer in the device → USB host direction is called the Rx
buffer.</p>
<p>Except, it appears the peripherial mode is a lie.  The functionality is entirely nopped
out in the driver.</p>
<h2 id="set_speed"><a class="header" href="#set_speed"><code>SET_SPEED</code></a></h2>
<p>Sets the clock frequency (for controller operation).</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x03</code> (short)</li>
<li>command payload: 32-bit word (requested frequency in Hz)</li>
<li>response payload: 32-bit word (actual frequency in Hz)</li>
</ul>
<p>This command returns the actual frequency used, as adjusted by the device
to match hardware capabilities.</p>
<h2 id="get_speed"><a class="header" href="#get_speed"><code>GET_SPEED</code></a></h2>
<p>Gets the clock frequency (for controller operation).</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x04</code> (short)</li>
<li>command payload: none</li>
<li>response payload: 32-bit word (frequency in Hz)</li>
</ul>
<h2 id="controller_put"><a class="header" href="#controller_put"><code>CONTROLLER_PUT</code></a></h2>
<p>Performs a "put" operation as a controller.  This consists of:</p>
<ul>
<li>a START condition</li>
<li>sending an address byte with the specified address and a write operation selected</li>
<li>sending the specified payload bytes</li>
<li>a STOP condition</li>
</ul>
<p>The command is:</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x05</code> (long)</li>
<li>command payload: 3 bytes:
<ul>
<li>byte 0: peripherial address</li>
<li>bytes 1-2: number of bytes to send</li>
</ul>
</li>
<li>response payload: none</li>
<li>long data OUT: the bytes to send</li>
<li>long data IN: none</li>
</ul>
<h2 id="controller_get"><a class="header" href="#controller_get"><code>CONTROLLER_GET</code></a></h2>
<p>Performs a "get" operation as a controller.  This consists of:</p>
<ul>
<li>a START condition</li>
<li>sending an address byte with the specified address and a read operation selected</li>
<li>receiving the specified number of bytes; each byte aside of the last one will be ACKed by the controller</li>
<li>a STOP condition</li>
</ul>
<p>The command is:</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x06</code> (long)</li>
<li>command payload: 3 bytes:
<ul>
<li>byte 0: peripherial address</li>
<li>bytes 1-2: number of bytes to receive</li>
</ul>
</li>
<li>response payload: none</li>
<li>long data OUT: none</li>
<li>long data IN: received bytes</li>
</ul>
<h2 id="controller_put_get"><a class="header" href="#controller_put_get"><code>CONTROLLER_PUT_GET</code></a></h2>
<p>Performs a "put+get" operation as a controller.  This consists of:</p>
<ul>
<li>a START condition</li>
<li>sending an address byte with the specified address and a write operation selected</li>
<li>sending the specified payload bytes</li>
<li>optionally, waiting a specified amount of time (0-65535µs)</li>
<li>a repeated START condition</li>
<li>sending an address byte with the specified address and a read operation selected</li>
<li>receiving the specified number of bytes; each byte aside of the last one will be ACKed by the controller</li>
<li>a STOP condition</li>
</ul>
<p>The command is:</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x07</code> (long)</li>
<li>command payload: 7 bytes:
<ul>
<li>byte 0: peripherial address</li>
<li>bytes 1-2: number of bytes to send</li>
<li>bytes 3-4: time to wait between send and receive, in µs</li>
<li>bytes 5-6: number of bytes to receive</li>
</ul>
</li>
<li>response payload: none</li>
<li>long data OUT: the bytes to send</li>
<li>long data IN: received bytes</li>
</ul>
<h2 id="controller_batch"><a class="header" href="#controller_batch"><code>CONTROLLER_BATCH</code></a></h2>
<p>Performs a batch operation as a controller.</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x08</code> (long)</li>
<li>command payload: 5 bytes:
<ul>
<li>bytes 0-1: total number of bytes to send (the batch command stream)</li>
<li>bytes 2-3: total number of bytes to receive</li>
<li>byte 4: ????? always 0, possible driver bug</li>
</ul>
</li>
<li>response payload: none</li>
<li>long data OUT: the bytes to send (batch command stream)</li>
<li>long data IN: received bytes</li>
</ul>
<p>The data sent as payload to this command is the batch command stream, with interleaved
batch commands and data to transmit.  The data received is the concatenation of received
data for all batch commands submitted.</p>
<p>The batch commands are variable-length and start with a single-byte opcode.  The low nibble
of the opcode is always equal to the length of the "header" of the batch command, while
the high nibble is the command type.  For the <code>BATCH_PUT</code> command, the data to transmit
immediately follows the header.  All other commands consist of just the header.  The batch
commands are:</p>
<ul>
<li><code>STOP</code> (sends a STOP condition)
<ul>
<li>byte 0: opcode (<code>0x11</code>)</li>
</ul>
</li>
<li><code>START_WRITE</code> (sends a START condition, then sends an address byte with write direction)
<ul>
<li>byte 0: opcode (<code>0x22</code>)</li>
<li>byte 1: peripherial address</li>
</ul>
</li>
<li><code>START_READ</code> (sends a START condition, then sends an address byte with read direction)
<ul>
<li>byte 0: opcode (<code>0x32</code>)</li>
<li>byte 1: peripherial address</li>
</ul>
</li>
<li><code>REP_START_WRITE</code> (sends a repeated START condition, then sends an address byte with write direction)
<ul>
<li>byte 0: opcode (<code>0x42</code>)</li>
<li>byte 1: peripherial address</li>
</ul>
</li>
<li><code>REP_START_READ</code> (sends a repeated START condition, then sends an address byte with read direction)
<ul>
<li>byte 0: opcode (<code>0x52</code>)</li>
<li>byte 1: peripherial address</li>
</ul>
</li>
<li><code>PUT</code> (sends data bytes)
<ul>
<li>byte 0: opcode (<code>0x63</code>)</li>
<li>bytes 1-2: number of bytes to send</li>
<li>bytes 3 and up: the bytes to send</li>
</ul>
</li>
<li><code>GET</code> (receives data bytes)
<ul>
<li>byte 0: opcode (<code>0x73</code>)</li>
<li>bytes 1-2: number of bytes to receive</li>
</ul>
</li>
<li><code>WAIT</code> (waits a specified amount of time)
<ul>
<li>byte 0: opcode (<code>0x83</code>)</li>
<li>bytes 1-2: amount of time to wait, in µs</li>
</ul>
</li>
</ul>
<h2 id="smb_query_alert"><a class="header" href="#smb_query_alert"><code>SMB_QUERY_ALERT</code></a></h2>
<p>Queries the state of the SMBus alert pin.</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x09</code> (short)</li>
<li>command payload: none</li>
<li>response payload: 1 byte, the <em>inverted</em> alert pin state:
<ul>
<li>0: alert pin inactive (set to 1)</li>
<li>1: alert pin active (set to 0)</li>
</ul>
</li>
</ul>
<h2 id="smb_set_suspend"><a class="header" href="#smb_set_suspend"><code>SMB_SET_SUSPEND</code></a></h2>
<p>Sets the state of the SMBus suspend pin.</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x0a</code> (short)</li>
<li>command payload: 1 byte, the <em>inverted</em> suspend pin state to set:
<ul>
<li>0: suspend pin inactive (set to 1)</li>
<li>1: suspend pin active (set to 0)</li>
</ul>
</li>
<li>response payload: none</li>
</ul>
<h2 id="smb_pec_enable"><a class="header" href="#smb_pec_enable"><code>SMB_PEC_ENABLE</code></a></h2>
<p>Enables SMBus PEC checking.</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x0b</code> (short)</li>
<li>command payload: none</li>
<li>response payload: none</li>
</ul>
<h2 id="smb_pec_disable"><a class="header" href="#smb_pec_disable"><code>SMB_PEC_DISABLE</code></a></h2>
<p>Disables SMBus PEC checking.</p>
<ul>
<li>subsystem: <code>0x07</code> (DTWI)</li>
<li>command type: <code>0x0c</code> (short)</li>
<li>command payload: none</li>
<li>response payload: none</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../digilent/dspi.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../digilent/daci.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../digilent/dspi.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../digilent/daci.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>



        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
